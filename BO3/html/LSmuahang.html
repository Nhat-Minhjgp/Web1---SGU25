<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thông Tin Tài Khoản - MASH</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="flex justify-between items-center px-8 py-4 bg-white shadow-md">
    <h2 class="text-2xl font-bold text-[#8B0000]">
      <a href="../index.html" class="hover:text-[#8B0000]">MASH</a>
    </h2>
    <nav class="hidden md:flex space-x-6 text-sm font-medium absolute left-1/2 transform -translate-x-1/2">
      <a href="../index.html" class="hover:text-[#8B0000]">Trang chủ</a>
      <a href="./sanpham.html" class="hover:text-[#8B0000]">Sản phẩm</a>
      <a href="./gioithieu.html" class="hover:text-[#8B0000]">Giới thiệu</a>
      <a href="./lienhe.html" class="hover:text-[#8B0000]">Liên hệ</a>
    </nav>
    <div class="flex items-center space-x-4">
      <!-- Đăng nhập + Giỏ hàng khi chưa đăng nhập -->
      <div id="loginSection" class="flex items-center space-x-2">
        <a href="./login.html" class="flex items-center text-[#8B0000] hover:text-red-900 transition">
          <img src="../icon/iconlogin.jpg" alt="Đăng nhập" class="w-6 h-6 object-contain rounded-full" />
        </a>
        <a href="./giohang.html">
          <img src="../icon/giohang.png" alt="Giỏ hàng" class="w-5 h-5 hover:scale-110 transition" />
        </a>
      </div>

      <!-- Profile + Giỏ hàng khi đã đăng nhập -->
      <div id="userProfile" class="hidden flex items-center space-x-2">
        <a href="./thongtinKH.html" title="Trang tài khoản">
          <img src="../img/iconafterlogin.jpg" alt="User"
            class="w-7 h-7 rounded-full object-cover border border-gray-300 hover:scale-110 transition" />
        </a>

        <span id="userName" class="text-sm font-medium text-[#8B0000]"></span>

        <!-- Nút đăng xuất -->
        <button id="logoutBtn" class="text-xs text-gray-500 hover:text-red-700 ml-2">(Đăng xuất)</button>

        <!-- Nút giỏ hàng -->
        <a href="./giohang.html">
          <img src="../icon/giohang.png" alt="Giỏ hàng" class="w-5 h-5 hover:scale-110 transition" />
        </a>
      </div>
    </div>
  </header>

  <div class="flex flex-col md:flex-row flex-1">
    
    <!-- SIDEBAR -->
    <div class="w-64  p-5 shadow-md bg-white">
        <h2 class="text-lg font-semibold mb-4 text-[#8B0000]">Tài khoản của tôi</h2>
        <nav>
            <ul>
                <li class="mb-3">
                    <a href="./thongtinKH.html" class="block hover:text-[#8B0000]">Thông tin cá nhân</a>
                </li>
                <li class="mb-3">
                    <a href="#" class="block hover:text-[#8B0000]">Lịch sử mua hàng</a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- MAIN CONTENT -->
    <div class="w-full  p-4 md:p-8">
        <h1 class="text-2xl font-extrabold mb-6 md:mb-8">Lịch sử mua hàng</h1>

        <div class="bg-white shadow-lg rounded-lg overflow-hidden border border-gray-200">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã đơn hàng</th>
                            <th class="px-4 py-3 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày đặt</th>
                            <th class="px-4 py-3 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sản phẩm</th>
                            <th class="px-4 py-3 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tổng tiền</th>
                            <th class="px-4 py-3 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                            <th class="px-4 py-3 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="orderTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Thông báo khi không có đơn hàng -->
        <div id="emptyOrderMessage" class="hidden mt-8 text-center">
            <div class="bg-white p-8 rounded-lg shadow-md">
                <svg class="w-16 h-16 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                </svg>
                <h3 class="mt-4 text-lg font-medium text-gray-900">Chưa có đơn hàng nào</h3>
                <p class="mt-2 text-gray-500">Bạn chưa có đơn hàng nào trong lịch sử mua hàng.</p>
                <a href="./sanpham.html" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-[#8B0000] hover:bg-red-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#8B0000]">
                    Mua sắm ngay
                </a>
            </div>
        </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="bg-white text-center py-4 border-t text-sm text-gray-600 mt-auto">
    © 2025 MASH Bakery. All rights reserved.
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
        const tbody = document.getElementById("orderTableBody");
        const emptyOrderMessage = document.getElementById("emptyOrderMessage");
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        
        // Kiểm tra đăng nhập
        if (!currentUser) {
            alert("Bạn cần đăng nhập để xem lịch sử mua hàng.");
            window.location.href = "./login.html";
            return;
        }

        // Xử lý hiển thị header
        const loginSection = document.getElementById("loginSection");
        const userProfile = document.getElementById("userProfile");
        const userName = document.getElementById("userName");
        
        if (currentUser) {
            // Hiển thị profile khi đã đăng nhập
            loginSection.classList.add("hidden");
            userProfile.classList.remove("hidden");
            userProfile.classList.add("flex");
            userName.textContent = currentUser.fullName || currentUser.username || currentUser.email;
        }
        
        // Lấy lịch sử mua hàng theo tài khoản
        const userOrders = getUserOrders(currentUser.email);
        
        // Sắp xếp đơn hàng theo thứ tự mới nhất trước
        userOrders.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        if (userOrders.length === 0) {
            // Ẩn bảng và hiển thị thông báo không có đơn hàng
            tbody.closest('.overflow-x-auto').style.display = 'none';
            emptyOrderMessage.classList.remove('hidden');
            return;
        }
        
        // Hiển thị đơn hàng dưới dạng bảng đơn giản
        let allItemsHtml = '';

        userOrders.forEach(order => {
            // Tính tổng số sản phẩm
            const totalItems = order.items.reduce((sum, item) => sum + item.quantity, 0);
            
            // Lấy tên sản phẩm đầu tiên (và thêm "+X sản phẩm" nếu có nhiều hơn 1)
            const firstProduct = order.items[0];
            let productDisplay = firstProduct.name;
            if (order.items.length > 1) {
                productDisplay += ` và ${order.items.length - 1} sản phẩm khác`;
            }
            
            const orderRow = `
                <tr class="hover:bg-gray-50 cursor-pointer" onclick="viewOrderSummary('${order.id}')">
                    <td class="px-4 py-4 md:px-6 md:py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-[#8B0000]">#${order.id}</div>
                    </td>
                    
                    <td class="px-4 py-4 md:px-6 md:py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${formatDate(order.date)}</div>
                    </td>
                    
                    <td class="px-4 py-4 md:px-6 md:py-4">
                        <div class="text-sm text-gray-900">${productDisplay}</div>
                        <div class="text-sm text-gray-500">${totalItems} sản phẩm</div>
                    </td>
                    
                    <td class="px-4 py-4 md:px-6 md:py-4 whitespace-nowrap">
                        <div class="text-sm font-semibold text-gray-900">${order.total.toLocaleString("vi-VN")}₫</div>
                    </td>
                    
                    <td class="px-4 py-4 md:px-6 md:py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(order.status)}">
                            ${getStatusText(order.status)}
                        </span>
                    </td>
                    
                    <td class="px-4 py-4 md:px-6 md:py-4 whitespace-nowrap">
                        <button onclick="event.stopPropagation(); viewOrderSummary('${order.id}')" 
                                class="text-[#8B0000] hover:text-red-900 text-sm font-medium bg-transparent border-none cursor-pointer">
                            Xem chi tiết
                        </button>
                    </td>
                </tr>
            `;
            allItemsHtml += orderRow;
        });
        
        tbody.innerHTML = allItemsHtml;
        
        // Xử lý nút Đăng xuất 
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
            logoutBtn.addEventListener("click", () => {
                localStorage.removeItem("currentUser");
                window.location.href = "../index.html"; // Chuyển hướng về trang chủ sau đăng xuất
            });
        }
        
        // Hàm lấy đơn hàng theo tài khoản
        function getUserOrders(userEmail) {
            // Lấy tất cả đơn hàng từ localStorage
            const allOrders = JSON.parse(localStorage.getItem("orders")) || [];
            
            // Lọc đơn hàng theo email của người dùng hiện tại
            return allOrders.filter(order => 
                order.customer && order.customer.email === userEmail
            );
        }
        
        // Hàm định dạng ngày
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        // Hàm lấy class CSS cho trạng thái
        function getStatusClass(status) {
            const statusClassMap = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'confirmed': 'bg-blue-100 text-blue-800',
                'shipping': 'bg-purple-100 text-purple-800',
                'completed': 'bg-green-100 text-green-800',
                'cancelled': 'bg-red-100 text-red-800'
            };
            return statusClassMap[status] || 'bg-yellow-100 text-yellow-800';
        }
        
        // Hàm lấy trạng thái đơn hàng
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Chờ xác nhận',
                'confirmed': 'Đã xác nhận',
                'shipping': 'Đang giao hàng',
                'completed': 'Đã hoàn thành',
                'cancelled': 'Đã hủy'
            };
            return statusMap[status] || 'Chờ xác nhận';
        }
    });

    // Hàm xem chi tiết đơn hàng (đặt ở global scope)
    function viewOrderSummary(orderId) {
        window.location.href = `./order-summary.html?orderId=${orderId}&from=history`;
    }
  </script>
</body>
</html>