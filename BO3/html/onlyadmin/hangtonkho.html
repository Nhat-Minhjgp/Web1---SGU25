<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quản lý Tồn kho</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    .card-hover {
      transition: all 0.3s ease;
    }

    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
    }

    .low-stock {
      background-color: rgba(239, 68, 68, 0.2);
      border-left: 4px solid #ef4444;
    }

    .medium-stock {
      background-color: rgba(245, 158, 11, 0.2);
      border-left: 4px solid #f59e0b;
    }

    .high-stock {
      background-color: rgba(16, 185, 129, 0.2);
      border-left: 4px solid #10b981;
    }
  </style>
</head>

<body class="bg-gray-900 text-white min-h-screen">
  <!-- HEADER -->
  <header class="flex justify-between items-center px-6 py-4 bg-gray-800 shadow-md">
    <div class="flex items-center space-x-4">
      <button onclick="goBack()"
        class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-semibold px-4 py-2 rounded-lg transition flex items-center">
        <i class="fas fa-arrow-left mr-2"></i> Quay lại
      </button>
      <h1 class="text-2xl font-bold text-cyan-400">Quản lý Tồn Kho</h1>
    </div>
  </header>

  <div class="flex h-[calc(100vh-64px)]">
    <!-- SIDEBAR -->
    <aside class="w-80 bg-gray-800 p-6 space-y-4 overflow-y-auto flex-shrink-0">
      <div class="pb-4 border-b border-gray-700">
        <h3 class="text-lg font-semibold text-cyan-400 mb-2">Thông tin tài khoản</h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-400">Tên đăng nhập:</span>
            <span id="adminEmail">quanly1</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-400">Đăng nhập lúc:</span>
            <span id="loginTime">10:30, 15/06/2023</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-400">Trạng thái:</span>
            <span class="text-green-400">Đang hoạt động</span>
          </div>
        </div>
      </div>

      <nav class="space-y-2 pt-2">
        <button onclick="window.location.href='quanlykhachhang.html'"
          class="block w-full text-left px-4 py-2 rounded-lg hover:text-cyan-400 hover:bg-gray-700 transition">
          <i class="fas fa-users mr-2"></i> Quản lý người dùng
        </button>
        <button onclick="window.location.href='quanlyloaisanpham.html'"
          class="block w-full text-left px-4 py-2 rounded-lg hover:text-cyan-400 hover:bg-gray-700 transition">
          <i class="fas fa-tags mr-2"></i> Loại sản phẩm
        </button>
        <button onclick="window.location.href='danhmucsanpham.html'"
          class="block w-full text-left px-4 py-2 rounded-lg hover:text-cyan-400 hover:bg-gray-700 transition">
          <i class="fas fa-boxes mr-2"></i> Danh mục sản phẩm
        </button>
        <button onclick="window.location.href='quanlyhangnhap.html'"
          class="block w-full text-left px-4 py-2 rounded-lg hover:text-cyan-400 hover:bg-gray-700 transition">
          <i class="fas fa-arrow-down mr-2"></i> Quản lý hàng nhập
        </button>
        <button onclick="window.location.href='quanlydondathang.html'"
          class="block w-full text-left px-4 py-2 rounded-lg hover:text-cyan-400 hover:bg-gray-700 transition">
          <i class="fas fa-receipt mr-2"></i> Quản lý đơn đặt hàng
        </button>
        <button onclick="window.location.href='giaban.html'"
          class="block w-full text-left px-4 py-2 rounded-lg hover:text-cyan-400 hover:bg-gray-700 transition">
          <i class="fas fa-tag mr-2"></i> Giá bán
        </button>
        <button onclick="window.location.href='hangtonkho.html'"
          class="block w-full text-left px-4 py-2 rounded-lg hover:text-cyan-400 hover:bg-gray-700 transition">
          <i class="fas fa-warehouse mr-2"></i> Tồn kho
        </button>
      </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 p-4 md:p-8 overflow-y-auto">
      <!-- Thống kê nhanh -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-gray-800 p-4 rounded-lg card-hover">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-gray-400 text-sm">Tổng sản phẩm</p>
              <h3 class="text-2xl font-bold text-white" id="totalProductsCount">0</h3>
            </div>
            <div class="bg-cyan-500 p-3 rounded-full">
              <i class="fas fa-box text-white"></i>
            </div>
          </div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg card-hover">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-gray-400 text-sm">Tổng tồn kho</p>
              <h3 class="text-2xl font-bold text-green-400" id="totalStock">0</h3>
            </div>
            <div class="bg-green-500 p-3 rounded-full">
              <i class="fas fa-boxes text-white"></i>
            </div>
          </div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg card-hover">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-gray-400 text-sm">Sản phẩm sắp hết</p>
              <h3 class="text-2xl font-bold text-red-400" id="lowStockCount">0</h3>
            </div>
            <div class="bg-red-500 p-3 rounded-full">
              <i class="fas fa-exclamation-triangle text-white"></i>
            </div>
          </div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg card-hover">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-gray-400 text-sm">Sản phẩm tìm thấy</p>
              <h3 class="text-2xl font-bold text-purple-400" id="filteredProductsCount">0</h3>
            </div>
            <div class="bg-purple-500 p-3 rounded-full">
              <i class="fas fa-filter text-white"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Bộ lọc sản phẩm -->
      <div class="bg-gray-800 p-4 rounded-lg mb-6">
        <h2 class="text-xl font-bold text-cyan-400 mb-4">
          <i class="fas fa-search mr-2"></i>Tra cứu tồn kho
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Tìm kiếm sản phẩm</label>
            <input type="text" id="productSearch" placeholder="Nhập tên sản phẩm..."
              class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 transition" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Loại sản phẩm</label>
            <select id="inventoryCategorySelect"
              class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
              <option value="">Tất cả loại</option>
              <option value="ngot">Nhân ngọt</option>
              <option value="man">Nhân mặn</option>
              <option value="dacbiet">Đặc biệt</option>
              <option value="chay">Chay</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Tình trạng tồn kho</label>
            <select id="stockStatusSelect"
              class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
              <option value="">Tất cả</option>
              <option value="low">Sắp hết hàng</option>
              <option value="medium">Tồn kho trung bình</option>
              <option value="high">Tồn kho cao</option>
            </select>
          </div>
          <div class="flex items-end">
            <button onclick="searchInventory()"
              class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-semibold px-6 py-2 rounded-lg transition w-full card-hover">
              <i class="fas fa-search mr-2"></i> Tìm kiếm
            </button>
          </div>
        </div>
      </div>

      <!-- Bảng tồn kho -->
      <div class="bg-gray-800 p-4 rounded-lg mb-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
          <h2 class="text-xl font-bold text-cyan-400">
            <i class="fas fa-boxes mr-2"></i>Danh sách tồn kho
          </h2>
          <button onclick="openStockAdjustmentModal()"
            class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-semibold px-4 py-2 rounded-lg transition flex items-center card-hover">
            <i class="fas fa-plus mr-2"></i> Điều chỉnh tồn kho
          </button>
        </div>

        <div class="overflow-x-auto rounded-lg">
          <table class="min-w-full divide-y divide-gray-700">
            <thead class="bg-gray-750">
              <tr>
                <th
                  class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer"
                  onclick="sortInventory('name')">
                  Sản phẩm <i class="fas fa-sort ml-1"></i>
                </th>
                <th
                  class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer"
                  onclick="sortInventory('currentStock')">
                  Tồn kho <i class="fas fa-sort ml-1"></i>
                </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                  Tồn tối thiểu
                </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                  Tình trạng
                </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                  Hành động
                </th>
              </tr>
            </thead>
            <tbody class="bg-gray-800 divide-y divide-gray-700" id="inventoryTable">
              <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Báo cáo nhập - xuất - tồn -->
      <div class="bg-gray-800 p-4 rounded-lg">
        <h2 class="text-xl font-bold text-cyan-400 mb-4">
          <i class="fas fa-chart-line mr-2"></i>Báo cáo Nhập - Xuất - Tồn
        </h2>

        <!-- Bộ lọc thời gian -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Từ ngày</label>
            <input type="date" id="startDate"
              class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 transition" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Đến ngày</label>
            <input type="date" id="endDate"
              class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 transition" />
          </div>
          <div class="flex items-end">
            <button onclick="generateStockReport()"
              class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-semibold px-6 py-2 rounded-lg transition w-full card-hover">
              <i class="fas fa-chart-bar mr-2"></i> Tạo báo cáo
            </button>
          </div>
        </div>

        <!-- Kết quả báo cáo -->
        <div class="overflow-x-auto rounded-lg">
          <table class="min-w-full divide-y divide-gray-700">
            <thead class="bg-gray-750">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                  Sản phẩm
                </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                  Tồn đầu kỳ
                </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                  Nhập
                </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                  Xuất
                </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                  Tồn cuối kỳ
                </th>
              </tr>
            </thead>
            <tbody class="bg-gray-800 divide-y divide-gray-700" id="stockReportTable">
              <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal điều chỉnh tồn kho -->
  <div id="stockAdjustmentModal"
    class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-cyan-400">Điều chỉnh tồn kho</h3>
        <button onclick="closeStockAdjustmentModal()" class="text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-300 mb-2">Sản phẩm</label>
        <select id="modalProductSelect"
          class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
          <option value="">Chọn sản phẩm</option>
        </select>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">Loại điều chỉnh</label>
          <select id="adjustmentType"
            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
            <option value="import">Nhập hàng</option>
            <option value="export">Xuất hàng</option>
           
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">Số lượng</label>
          <input type="number" id="adjustmentQuantity" min="0"
            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 transition" />
        </div>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-300 mb-2">Lý do</label>
        <textarea id="adjustmentReason"
          class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 transition"
          rows="2"></textarea>
      </div>

      <!-- Cảnh báo khi xuất quá số lượng -->
      <div id="exportWarning" class="hidden bg-red-900 text-red-200 p-3 rounded-lg mb-4">
        <div class="flex items-center">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          <span id="warningMessage"></span>
        </div>
      </div>

      <div class="flex justify-end space-x-3">
        <button onclick="closeStockAdjustmentModal()"
          class="bg-gray-700 hover:bg-gray-600 text-white font-semibold px-4 py-2 rounded-lg transition">
          Hủy
        </button>
        <button onclick="saveStockAdjustment()"
          class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-semibold px-4 py-2 rounded-lg transition">
          <i class="fas fa-save mr-2"></i> Lưu
        </button>
      </div>
    </div>
  </div>

  <script>
    // Dữ liệu tồn kho
    const inventory = [
      {
        id: 1,
        name: "Mãng Cầu Xiêm Sen",
        category: "ngot",
        currentStock: 50,
        minStock: 20,
        maxStock: 100,
        stockHistory: [
          { date: "2023-10-01", type: "import", quantity: 100, reason: "Nhập hàng đầu kỳ" },
          { date: "2023-10-15", type: "export", quantity: 30, reason: "Bán hàng" },
          { date: "2023-10-20", type: "export", quantity: 20, reason: "Bán hàng" }
        ]
      },
      {
        id: 2,
        name: "Sữa Dừa Cafe",
        category: "ngot",
        currentStock: 15,
        minStock: 20,
        maxStock: 80,
        stockHistory: [
          { date: "2023-10-01", type: "import", quantity: 50, reason: "Nhập hàng đầu kỳ" },
          { date: "2023-10-10", type: "export", quantity: 25, reason: "Bán hàng" },
          { date: "2023-10-18", type: "export", quantity: 10, reason: "Bán hàng" }
        ]
      },
      {
        id: 3,
        name: "Nấm Truffle",
        category: "dacbiet",
        currentStock: 5,
        minStock: 5,
        maxStock: 30,
        stockHistory: [
          { date: "2023-10-05", type: "import", quantity: 15, reason: "Nhập hàng" },
          { date: "2023-10-12", type: "export", quantity: 5, reason: "Bán hàng" },
          { date: "2023-10-22", type: "export", quantity: 5, reason: "Bán hàng" }
        ]
      },
      {
        id: 4,
        name: "Tomyum Hải Sản",
        category: "man",
        currentStock: 80,
        minStock: 30,
        maxStock: 120,
        stockHistory: [
          { date: "2023-10-01", type: "import", quantity: 100, reason: "Nhập hàng đầu kỳ" },
          { date: "2023-10-08", type: "export", quantity: 10, reason: "Bán hàng" },
          { date: "2023-10-16", type: "export", quantity: 10, reason: "Bán hàng" }
        ]
      },
      {
        id: 5,
        name: "Bò Sốt Tiêu Đen",
        category: "man",
        currentStock: 25,
        minStock: 15,
        maxStock: 60,
        stockHistory: [
          { date: "2023-10-03", type: "import", quantity: 40, reason: "Nhập hàng" },
          { date: "2023-10-14", type: "export", quantity: 10, reason: "Bán hàng" },
          { date: "2023-10-21", type: "export", quantity: 5, reason: "Bán hàng" }
        ]
      },
    ];

    let currentInventorySort = { field: "name", direction: "asc" };
    let currentAdjustingProduct = null;

    // Hiển thị bảng tồn kho
    function renderInventoryTable(filteredInventory = inventory) {
      const tableBody = document.getElementById("inventoryTable");
      tableBody.innerHTML = "";

      // Cập nhật thống kê
      updateInventoryStats(filteredInventory);

      filteredInventory.forEach((product) => {
        const row = document.createElement("tr");

        // Xác định tình trạng tồn kho
        let stockStatus = "high";
        let statusClass = "high-stock";
        let statusText = "Tồn kho cao";

        if (product.currentStock <= product.minStock) {
          stockStatus = "low";
          statusClass = "low-stock";
          statusText = "Sắp hết hàng";
        } else if (product.currentStock <= product.minStock * 1.5) {
          stockStatus = "medium";
          statusClass = "medium-stock";
          statusText = "Tồn kho trung bình";
        }

        row.className = `hover:bg-gray-750 transition ${statusClass}`;

        row.innerHTML = `
        <td class="px-4 py-4 whitespace-nowrap">
          <div class="text-sm font-medium text-white">${product.name}</div>
          <div class="text-sm text-gray-400">${getCategoryName(product.category)}</div>
        </td>
        <td class="px-4 py-4 whitespace-nowrap text-sm text-white">
          ${product.currentStock}
        </td>
        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-300">
          ${product.minStock}
        </td>
        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium ${stockStatus === 'low' ? 'text-red-400' : stockStatus === 'medium' ? 'text-yellow-400' : 'text-green-400'}">
          ${statusText}
        </td>
        <td class="px-4 py-4 whitespace-nowrap">
          <button onclick="adjustStock(${product.id})" class="text-xs bg-cyan-500 hover:bg-cyan-600 text-white px-3 py-1 rounded transition mr-2">
            <i class="fas fa-edit mr-1"></i>Điều chỉnh
          </button>
          <button onclick="viewStockHistory(${product.id})" class="text-xs bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded transition">
            <i class="fas fa-history mr-1"></i>Lịch sử
          </button>
        </td>
      `;

        tableBody.appendChild(row);
      });
    }

    // Cập nhật thống kê tồn kho
    function updateInventoryStats(inventoryList) {
      const totalProducts = inventory.length;
      const filteredCount = inventoryList.length;
      const totalStock = inventoryList.reduce((sum, p) => sum + p.currentStock, 0);
      const lowStockCount = inventoryList.filter(p => p.currentStock <= p.minStock).length;

      document.getElementById("totalProductsCount").textContent = totalProducts;
      document.getElementById("filteredProductsCount").textContent = filteredCount;
      document.getElementById("totalStock").textContent = totalStock;
      document.getElementById("lowStockCount").textContent = lowStockCount;
    }

    // Tìm kiếm tồn kho
    function searchInventory() {
      const searchTerm = document.getElementById("productSearch").value.toLowerCase();
      const category = document.getElementById("inventoryCategorySelect").value;
      const stockStatus = document.getElementById("stockStatusSelect").value;

      let filteredInventory = inventory.filter((product) => {
        const matchesSearch = product.name.toLowerCase().includes(searchTerm);
        const matchesCategory = !category || product.category === category;

        let matchesStockStatus = true;
        if (stockStatus) {
          if (stockStatus === "low") {
            matchesStockStatus = product.currentStock <= product.minStock;
          } else if (stockStatus === "medium") {
            matchesStockStatus = product.currentStock > product.minStock &&
              product.currentStock <= product.minStock * 1.5;
          } else if (stockStatus === "high") {
            matchesStockStatus = product.currentStock > product.minStock * 1.5;
          }
        }

        return matchesSearch && matchesCategory && matchesStockStatus;
      });

      renderInventoryTable(filteredInventory);
    }

    // Sắp xếp tồn kho
    function sortInventory(field) {
      if (currentInventorySort.field === field) {
        currentInventorySort.direction =
          currentInventorySort.direction === "asc" ? "desc" : "asc";
      } else {
        currentInventorySort.field = field;
        currentInventorySort.direction = "asc";
      }

      const sortedInventory = [...inventory].sort((a, b) => {
        let aValue = a[field];
        let bValue = b[field];

        if (aValue < bValue)
          return currentInventorySort.direction === "asc" ? -1 : 1;
        if (aValue > bValue)
          return currentInventorySort.direction === "asc" ? 1 : -1;
        return 0;
      });

      renderInventoryTable(sortedInventory);
    }

    // Mở modal điều chỉnh tồn kho
    function openStockAdjustmentModal(productId = null) {
      const modal = document.getElementById("stockAdjustmentModal");
      const productSelect = document.getElementById("modalProductSelect");
      const adjustmentType = document.getElementById("adjustmentType");
      const adjustmentQuantity = document.getElementById("adjustmentQuantity");
      const exportWarning = document.getElementById("exportWarning");

      // Ẩn cảnh báo khi mở modal
      exportWarning.classList.add("hidden");

      productSelect.innerHTML = '<option value="">Chọn sản phẩm</option>';
      inventory.forEach((product) => {
        const option = document.createElement("option");
        option.value = product.id;
        option.textContent = product.name;
        productSelect.appendChild(option);
      });

      if (productId) {
        currentAdjustingProduct = inventory.find((p) => p.id === productId);

        if (currentAdjustingProduct) {
          productSelect.value = currentAdjustingProduct.id;
          productSelect.disabled = true;
        }
      } else {
        currentAdjustingProduct = null;
        productSelect.disabled = false;
      }

      // Reset các trường nhập liệu
      adjustmentQuantity.value = "";

      // Thêm sự kiện kiểm tra số lượng khi thay đổi
      adjustmentType.addEventListener("change", checkExportQuantity);
      adjustmentQuantity.addEventListener("input", checkExportQuantity);

      modal.classList.remove("hidden");
    }

    // Kiểm tra số lượng xuất có vượt quá tồn kho không
    function checkExportQuantity() {
      const adjustmentType = document.getElementById("adjustmentType").value;
      const adjustmentQuantity = parseInt(document.getElementById("adjustmentQuantity").value) || 0;
      const productId = parseInt(document.getElementById("modalProductSelect").value);
      const exportWarning = document.getElementById("exportWarning");
      const warningMessage = document.getElementById("warningMessage");

      if (adjustmentType === "export" && productId) {
        const product = inventory.find((p) => p.id === productId);
        if (product && adjustmentQuantity > product.currentStock) {
          exportWarning.classList.remove("hidden");
          warningMessage.textContent = `Cảnh báo: Số lượng xuất (${adjustmentQuantity}) vượt quá tồn kho hiện tại (${product.currentStock})!`;
        } else {
          exportWarning.classList.add("hidden");
        }
      } else {
        exportWarning.classList.add("hidden");
      }
    }

    // Đóng modal điều chỉnh tồn kho
    function closeStockAdjustmentModal() {
      document.getElementById("stockAdjustmentModal").classList.add("hidden");
      currentAdjustingProduct = null;
    }

    // Lưu điều chỉnh tồn kho
    function saveStockAdjustment() {
      const productId = parseInt(document.getElementById("modalProductSelect").value);
      const adjustmentType = document.getElementById("adjustmentType").value;
      const quantity = parseInt(document.getElementById("adjustmentQuantity").value);
      const reason = document.getElementById("adjustmentReason").value;

      if (!productId || !quantity || quantity <= 0) {
        alert("Vui lòng điền đầy đủ thông tin");
        return;
      }

      const product = inventory.find((p) => p.id === productId);
      if (!product) {
        alert("Sản phẩm không tồn tại");
        return;
      }

      // Kiểm tra nếu xuất quá số lượng tồn kho
      if (adjustmentType === "export" && quantity > product.currentStock) {
        alert(`Không thể xuất hàng! Số lượng xuất (${quantity}) vượt quá tồn kho hiện tại (${product.currentStock})`);
        return;
      }

      // Thêm lịch sử điều chỉnh
      const today = new Date().toISOString().split('T')[0];
      product.stockHistory.push({
        date: today,
        type: adjustmentType,
        quantity: quantity,
        reason: reason
      });

      // Cập nhật tồn kho hiện tại
      if (adjustmentType === "import") {
        product.currentStock += quantity;
      } else if (adjustmentType === "export") {
        product.currentStock -= quantity;
        if (product.currentStock < 0) product.currentStock = 0;
      } else if (adjustmentType === "adjust") {
        product.currentStock = quantity;
      }

      renderInventoryTable();
      closeStockAdjustmentModal();
      alert("Đã điều chỉnh tồn kho thành công!");
    }

    // Điều chỉnh tồn kho nhanh
    function adjustStock(productId) {
      openStockAdjustmentModal(productId);
    }

    // Xem lịch sử tồn kho
    function viewStockHistory(productId) {
      const product = inventory.find((p) => p.id === productId);
      if (product) {
        let historyText = `Lịch sử tồn kho: ${product.name}\n\n`;

        product.stockHistory.forEach(record => {
          const typeText = record.type === 'import' ? 'Nhập' :
            record.type === 'export' ? 'Xuất' : 'Điều chỉnh';
          historyText += `${record.date}: ${typeText} ${record.quantity} - ${record.reason}\n`;
        });

        historyText += `\nTồn kho hiện tại: ${product.currentStock}`;

        alert(historyText);
      }
    }

    // Tạo báo cáo nhập - xuất - tồn
    function generateStockReport() {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;

      if (!startDate || !endDate) {
        alert("Vui lòng chọn khoảng thời gian");
        return;
      }

      const tableBody = document.getElementById("stockReportTable");
      tableBody.innerHTML = "";

      inventory.forEach(product => {
        // Tính toán số liệu trong khoảng thời gian
        const periodData = calculatePeriodStock(product, startDate, endDate);

        const row = document.createElement("tr");
        row.className = "hover:bg-gray-750 transition";

        row.innerHTML = `
        <td class="px-4 py-4 whitespace-nowrap text-sm text-white">${product.name}</td>
        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-300">${periodData.openingStock}</td>
        <td class="px-4 py-4 whitespace-nowrap text-sm text-green-400">${periodData.totalImport}</td>
        <td class="px-4 py-4 whitespace-nowrap text-sm text-red-400">${periodData.totalExport}</td>
        <td class="px-4 py-4 whitespace-nowrap text-sm text-white">${periodData.closingStock}</td>
      `;

        tableBody.appendChild(row);
      });
    }

    // Tính toán số liệu tồn kho trong khoảng thời gian
    function calculatePeriodStock(product, startDate, endDate) {
      let openingStock = product.currentStock;
      let totalImport = 0;
      let totalExport = 0;

      // Tính toán dựa trên lịch sử tồn kho
      product.stockHistory.forEach(record => {
        if (record.date < startDate) {
          // Trước kỳ báo cáo
          if (record.type === 'import') {
            openingStock -= record.quantity;
          } else if (record.type === 'export') {
            openingStock += record.quantity;
          }
        } else if (record.date >= startDate && record.date <= endDate) {
          // Trong kỳ báo cáo
          if (record.type === 'import') {
            totalImport += record.quantity;
          } else if (record.type === 'export') {
            totalExport += record.quantity;
          }
        }
      });

      const closingStock = openingStock + totalImport - totalExport;

      return {
        openingStock,
        totalImport,
        totalExport,
        closingStock
      };
    }

    // Các hàm hỗ trợ khác
    function getCategoryName(category) {
      const categories = {
        ngot: "Nhân ngọt",
        man: "Nhân mặn",
        dacbiet: "Đặc biệt",
        chay: "Chay",
      };
      return categories[category] || "Không xác định";
    }
    function logout() {
      if (confirm("Bạn có chắc chắn muốn đăng xuất?")) {
        alert("Đã đăng xuất!");
        window.location.href = "adlog.html";
      }
    }
    function goBack() {
      window.location.href = "daodienad.html";
    }

    // Khởi tạo trang
    document.addEventListener("DOMContentLoaded", function () {
      renderInventoryTable();

      // Đặt ngày mặc định cho báo cáo (tháng hiện tại)
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

      document.getElementById("startDate").value = firstDay.toISOString().split('T')[0];
      document.getElementById("endDate").value = lastDay.toISOString().split('T')[0];

      // Tạo báo cáo mặc định
      generateStockReport();
    });
  </script>
</body>

</html>