<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thông Tin Tài Khoản - MASH</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="flex justify-between items-center px-8 py-4 bg-white shadow-md">
    <h2 class="text-2xl font-bold text-[#8B0000]">
        <a href="./pages.html" class="hover:text-[#8B0000]">MASH</a>
      </h2>
      <nav class="hidden md:flex space-x-6 text-sm font-medium absolute left-1/2 transform -translate-x-1/2">
        <a href="./pages.html" class="hover:text-[#8B0000]">Trang chủ</a>
        <a href="./sanpham.html" class="hover:text-[#8B0000]">Sản phẩm</a>
        <a href="./gioithieu.html" class="hover:text-[#8B0000]">Giới thiệu</a>
        <a href="./lienhe.html" class="hover:text-[#8B0000]">Liên hệ</a>
      </nav>
  
    <button id="logoutBtn" class="bg-[#8B0000] text-white px-4 py-2 rounded-full hover:bg-red-900 transition">
      Đăng xuất
    </button>
  </header>

  <div class="flex flex-col md:flex-row flex-1">
    
    <!-- SIDEBAR -->
    <div class="w-full md:w-1/4 p-6 border-r border-gray-200 bg-white">
        <h2 class="text-xl font-bold mb-6 text-red-700">Tài khoản của tôi</h2>
        <nav>
            <ul>
                <li class="mb-3">
                    <a href="./thongtinKH.html" class="text-gray-700 hover:text-red-700">Thông tin cá nhân</a>
                </li>
                <li class="mb-3">
                    <a href="#" class="font-bold text-red-700 border-l-4 border-red-700 pl-2">Lịch sử mua hàng</a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- MAIN CONTENT -->
    <div class="w-full md:w-3/4 p-4 md:p-8">
        <h1 class="text-2xl font-extrabold mb-6 md:mb-8">Lịch sử mua hàng</h1>

        <div class="bg-white shadow-lg rounded-lg overflow-hidden border border-gray-200">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên Sản Phẩm</th>
                            <th class="px-4 py-3 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Số Lượng</th>
                            <th class="px-4 py-3 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày Đặt</th>
                            <th class="px-4 py-3 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thành Tiền</th>
                        </tr>
                    </thead>
                    <tbody id="orderTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Thông báo khi không có đơn hàng -->
        <div id="emptyOrderMessage" class="hidden mt-8 text-center">
            <div class="bg-white p-8 rounded-lg shadow-md">
                <svg class="w-16 h-16 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                </svg>
                <h3 class="mt-4 text-lg font-medium text-gray-900">Chưa có đơn hàng nào</h3>
                <p class="mt-2 text-gray-500">Bạn chưa có đơn hàng nào trong lịch sử mua hàng.</p>
                <a href="./sanpham.html" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-[#8B0000] hover:bg-red-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#8B0000]">
                    Mua sắm ngay
                </a>
            </div>
        </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="bg-white text-center py-4 border-t text-sm text-gray-600 mt-auto">
    © 2025 MASH Bakery. All rights reserved.
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
        const tbody = document.getElementById("orderTableBody");
        const emptyOrderMessage = document.getElementById("emptyOrderMessage");
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        
        // Kiểm tra đăng nhập
        if (!currentUser) {
            alert("Bạn cần đăng nhập để xem lịch sử mua hàng.");
            window.location.href = "./login.html";
            return;
        }
        
        // Lấy lịch sử mua hàng theo tài khoản
        const userOrders = getUserOrders(currentUser.email);
        
        if (userOrders.length === 0) {
            // Ẩn bảng và hiển thị thông báo không có đơn hàng
            tbody.closest('.overflow-x-auto').style.display = 'none';
            emptyOrderMessage.classList.remove('hidden');
            return;
        }
        
        // Hiển thị đơn hàng
        let allItemsHtml = '';

        userOrders.forEach(order => {
            // Thêm header cho mỗi đơn hàng
            const orderHeader = `
                <tr class="bg-gray-100 border-t-2 border-gray-300">
                    <td colspan="4" class="px-4 py-3 md:px-6 md:py-3">
                        <div class="flex flex-col md:flex-row md:justify-between md:items-center">
                            <div>
                                <span class="font-bold text-[#8B0000]">Mã đơn hàng: #${order.id}</span>
                                <span class="ml-4 text-sm text-gray-600">${formatDate(order.date)}</span>
                            </div>
                            <div class="mt-1 md:mt-0">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(order.status)}">
                                    ${getStatusText(order.status)}
                                </span>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
            allItemsHtml += orderHeader;
            
            let isFirstItem = true; 

            order.items.forEach(item => {
                const itemTotal = (item.price || 0) * item.quantity;
                
                const itemRow = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 md:px-6 md:py-3 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                        
                        <td class="px-4 py-3 md:px-6 md:py-3 whitespace-nowrap text-sm text-gray-500">${item.quantity}</td>
                        
                        ${isFirstItem ? 
                            `<td rowspan="${order.items.length}" class="px-4 py-3 md:px-6 md:py-3 whitespace-nowrap text-sm text-gray-500 border-l border-r border-gray-100 font-semibold align-top pt-4">
                                ${formatDate(order.date)}
                            </td>` 
                            : ''
                        }

                        <td class="px-4 py-3 md:px-6 md:py-3 whitespace-nowrap text-sm text-gray-900">
                            ${itemTotal.toLocaleString("vi-VN")} VNĐ
                        </td>
                    </tr>
                `;
                allItemsHtml += itemRow;
                
                isFirstItem = false; 
            });
            
            // Thêm tổng tiền cho đơn hàng
            const totalRow = `
                <tr class="bg-gray-50">
                    <td colspan="3" class="px-4 py-2 md:px-6 md:py-2 text-right font-bold text-gray-800">TỔNG ĐƠN:</td>
                    <td class="px-4 py-2 md:px-6 md:py-2 whitespace-nowrap font-bold text-[#8B0000]">
                        ${order.total.toLocaleString("vi-VN")} VNĐ
                    </td>
                </tr>
            `;
            allItemsHtml += totalRow;
            
            // Thêm dòng trống để phân tách các đơn hàng
            allItemsHtml += `<tr class="h-4 bg-gray-100"><td colspan="4"></td></tr>`;
        });
        
        tbody.innerHTML = allItemsHtml;
        
        // Xử lý nút Đăng xuất 
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
            logoutBtn.addEventListener("click", () => {
                localStorage.removeItem("currentUser");
                window.location.href = "./pages.html"; // Chuyển hướng về trang chủ sau đăng xuất
            });
        }
        
        // Hàm lấy đơn hàng theo tài khoản
        function getUserOrders(userEmail) {
            // Lấy tất cả đơn hàng từ localStorage
            const allOrders = JSON.parse(localStorage.getItem("orders")) || [];
            
            // Lọc đơn hàng theo email của người dùng hiện tại
            return allOrders.filter(order => 
                order.customer && order.customer.email === userEmail
            );
        }
        
        // Hàm định dạng ngày
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Hàm lấy class CSS cho trạng thái
        function getStatusClass(status) {
            const statusClassMap = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'confirmed': 'bg-blue-100 text-blue-800',
                'shipping': 'bg-purple-100 text-purple-800',
                'completed': 'bg-green-100 text-green-800',
                'cancelled': 'bg-red-100 text-red-800'
            };
            return statusClassMap[status] || 'bg-yellow-100 text-yellow-800';
        }
        
        // Hàm lấy trạng thái đơn hàng
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Chờ xác nhận',
                'confirmed': 'Đã xác nhận',
                'shipping': 'Đang giao hàng',
                'completed': 'Đã hoàn thành',
                'cancelled': 'Đã hủy'
            };
            return statusMap[status] || 'Chờ xác nhận';
        }
    });
  </script>
</body>
</html>